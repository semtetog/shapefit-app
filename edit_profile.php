<?phprequire_once 'includes/config.php';require_once 'includes/auth.php';requireLogin();require_once 'includes/db.php';require_once 'includes/functions.php';$user_id = $_SESSION['user_id'];if (empty($_SESSION['csrf_token'])) { $_SESSION['csrf_token'] = bin2hex(random_bytes(32)); }$csrf_token_for_html = $_SESSION['csrf_token'];$user_data = getUserProfileData($conn, $user_id);if (!$user_data) {     $page_title = "Erro";    require_once APP_ROOT_PATH . '/includes/layout_header.php';    echo '<div class="container"><p class="error-message">Erro ao carregar os dados do seu perfil. Por favor, tente novamente mais tarde.</p></div>';    require_once APP_ROOT_PATH . '/includes/layout_footer.php';    die();}$all_restrictions = [];$result_all = $conn->query("SELECT id, name FROM sf_dietary_restrictions_options ORDER BY name ASC");while ($row = $result_all->fetch_assoc()) {    $all_restrictions[$row['id']] = $row['name'];}$user_selected_restrictions = [];if (!empty($user_data['has_dietary_restrictions'])) {    $stmt_user = $conn->prepare("SELECT restriction_id FROM sf_user_selected_restrictions WHERE user_id = ?");    $stmt_user->bind_param("i", $user_id);    $stmt_user->execute();    $result_user = $stmt_user->get_result();    while ($row = $result_user->fetch_assoc()) {         $user_selected_restrictions[] = $row['restriction_id'];     }    $stmt_user->close();}$custom_photo_filename = $user_data['profile_image_filename'] ?? null;if ($custom_photo_filename) {    $profile_image_url = BASE_ASSET_URL . '/assets/images/users/' . htmlspecialchars($custom_photo_filename);} else {    $gender = strtolower($user_data['gender'] ?? 'male');    $profile_image_url = ($gender === 'female') ? 'https://i.ibb.co/XkpfDjbj/FEMININO.webp' : 'https://i.ibb.co/gLcMfWyn/MASCULINO.webp';}$page_title = "Editar Perfil";$extra_css = ['edit_profile.css', 'modal.css'];$extra_js = ['edit_profile_logic.js'];require_once APP_ROOT_PATH . '/includes/layout_header.php';?><div class="container edit-profile-container">    <div class="header-nav">        <a href="<?php echo BASE_APP_URL; ?>/more_options.php" class="back-button"><i class="fas fa-chevron-left"></i></a>        <h1 class="page-title">Editar Perfil</h1>    </div>    <form id="edit-profile-form" novalidate>        <div class="profile-picture-section content-fade-in" style="animation-delay: 0.1s;">            <div class="profile-picture-wrapper">                <img src="<?php echo $profile_image_url; ?>" alt="Foto de Perfil" id="profile-picture-display" class="profile-picture">                <label for="profile-picture-input" class="edit-picture-overlay" title="Alterar foto">                    <i class="fas fa-pencil-alt icon-edit"></i><i class="fas fa-spinner fa-spin icon-loading" style="display: none;"></i>                </label>                <input type="file" id="profile-picture-input" accept="image/jpeg, image/png, image/webp" style="display: none;">            </div>            <div id="upload-status" class="upload-status"></div>        </div>                <div class="form-section content-fade-in" style="animation-delay: 0.2s;">            <h2 class="form-section-title">Dados Pessoais</h2>            <div class="form-group"><label for="full_name">Nome Completo</label><input type="text" id="full_name" name="full_name" class="form-control" value="<?php echo htmlspecialchars($user_data['name'] ?? ''); ?>" required></div>            <div class="form-group"><label for="dob">Data de Nascimento</label><input type="date" id="dob" name="dob" class="form-control" value="<?php echo htmlspecialchars($user_data['dob'] ?? ''); ?>" required></div>            <div class="form-group"><label for="gender">Gênero</label><select id="gender" name="gender" class="form-control" required><option value="male" <?php if($user_data['gender'] === 'male') echo 'selected'; ?>>Masculino</option><option value="female" <?php if($user_data['gender'] === 'female') echo 'selected'; ?>>Feminino</option><option value="other" <?php if($user_data['gender'] === 'other') echo 'selected'; ?>>Outro</option></select></div>        </div>        <div class="form-section content-fade-in" style="animation-delay: 0.3s;">            <h2 class="form-section-title">Dados Físicos e Metas</h2>            <div class="form-group-grid">                                         </div>            <div class="form-group"><label for="objective">Objetivo</label><select id="objective" name="objective" class="form-control" required><option value="lose_fat" <?php if($user_data['objective'] === 'lose_fat') echo 'selected'; ?>>Perder gordura</option><option value="maintain_weight" <?php if($user_data['objective'] === 'maintain_weight') echo 'selected'; ?>>Manter peso</option><option value="gain_muscle" <?php if($user_data['objective'] === 'gain_muscle') echo 'selected'; ?>>Ganhar massa muscular</option></select></div>            <div class="form-group">                <label for="activity_level">Nível de Atividade</label>                <select id="activity_level" name="activity_level" class="form-control" required>                    <option value="sedentary" <?php if($user_data['activity_level'] === 'sedentary') echo 'selected'; ?>>Sedentário (não pratico)</option>                    <option value="sedentary_to_1x" <?php if($user_data['activity_level'] === 'sedentary_to_1x') echo 'selected'; ?>>Muito Leve (1x/semana)</option>                    <option value="light_2_3x" <?php if($user_data['activity_level'] === 'light_2_3x') echo 'selected'; ?>>Leve (2-3x/semana)</option>                    <option value="moderate_3_5x" <?php if($user_data['activity_level'] === 'moderate_3_5x') echo 'selected'; ?>>Moderado (3-5x/semana)</option>                    <option value="intense_5x_plus" <?php if($user_data['activity_level'] === 'intense_5x_plus') echo 'selected'; ?>>Intenso (5x+/semana)</option>                    <option value="athlete" <?php if($user_data['activity_level'] === 'athlete') echo 'selected'; ?>>Atleta (treino intenso 2x/dia)</option>                </select>            </div>            <!-- [INÍCIO DA CORREÇÃO] - CAMPO FALTANTE ADICIONADO -->            <div class="form-group">                <label for="bowel_movement">Funcionamento do Intestino</label>                <select id="bowel_movement" name="bowel_movement" class="form-control" required>                    <option value="daily" <?php if($user_data['bowel_movement'] === 'daily') echo 'selected'; ?>>Diariamente</option>                    <option value="alternate_days" <?php if($user_data['bowel_movement'] === 'alternate_days') echo 'selected'; ?>>Dias alternados</option>                    <option value="every_3_plus_days" <?php if($user_data['bowel_movement'] === 'every_3_plus_days') echo 'selected'; ?>>A cada 3+ dias</option>                </select>            </div>            <!-- [FIM DA CORREÇÃO] -->        </div>        <div class="form-actions content-fade-in" style="animation-delay: 0.5s;">             <button type="submit" class="btn btn-primary">Salvar Alterações</button>        </div>        <!-- MODAL DE RESTRIÇÕES (dentro do form para ser enviado) -->        <div id="restrictions-modal" class="modal">            <div class="modal-overlay"></div>            <div class="modal-content">                <button type="button" class="modal-close-btn">×</button>                <h3 class="modal-title">Restrições Alimentares</h3>                <div class="checkbox-group">                    <?php foreach ($all_restrictions as $id => $name): ?>                        <div class="checkbox-item">                            <input type="checkbox" id="restriction_<?php echo $id; ?>" name="restrictions[]" value="<?php echo $id; ?>" <?php if (in_array($id, $user_selected_restrictions)) echo 'checked'; ?>>                            <label for="restriction_<?php echo $id; ?>"><?php echo htmlspecialchars($name); ?></label>                        </div>                    <?php endforeach; ?>                </div>                <button type="button" class="btn btn-secondary modal-confirm-btn">Confirmar</button>            </div>        </div>    </form></div><input type="hidden" id="csrf_token_main_app" value="<?php echo $csrf_token_for_html; ?>"><?phpinclude APP_ROOT_PATH . '/includes/layout_bottom_nav.php';require_once APP_ROOT_PATH . '/includes/layout_footer.php';?>